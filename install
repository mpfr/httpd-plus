#!/bin/ksh
#
# Copyright (c) 2020 Matthias Pressfreund
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#

srcdir='/usr/src/usr.sbin/httpd'
patchdir="$(pwd)/$(dirname $0)"

restore()
{
	echo -n 'Restoring original sources ... '
	cd ${srcdir}/..
	rm -rf ${srcdir} && mv $1 ${srcdir}
	[[ $? -eq 0 ]] && echo 'Done.' || echo 'Failed.'
}

if [[ $(id -u) != 0 ]]; then
	echo 'Need root privileges.'
	exit 1
fi
if [[ ! -d ${srcdir} ]]; then
	echo 'Missing source tree.'
	exit 1
fi

chksum0=$(find ${srcdir} \( -name '*.[chy578]' -o -name 'Makefile' \) \
	-type f -maxdepth 1 -exec sha256 {} \; | sort -k 2 | sha256)
chksum1='7e383a5b1e09804f332ce25b2fe8d310d46127f23b05994e5bb9a7cb4db44ec2'
if [[ ${chksum0} != ${chksum1} ]]; then
	echo 'Sources and patches do not match. Make sure both are up-to-date.'
	exit 1
fi

echo -n 'Backing up original sources ... '
while :
do
	bakdir="${srcdir}~$RANDOM"
	[[ -d ${bakdir} ]] || break
done
cp -a ${srcdir} ${bakdir}
if [[ $? -eq 0 ]]; then
	echo 'Done.'
else
	echo 'Failed.'
	exit 1
fi

echo 'Applying patch files ...'
for f in $(find ${patchdir} -type f -name '*.patch' | sort); do
	echo "... $(basename ${f} .patch) ..."
	cat ${f} | (cd /usr/src && patch -p0)
	if [[ $? -ne 0 ]]; then
		restore ${bakdir}
		exit 1
	fi
done

cd ${srcdir}

echo 'Building and installing httpd-plus binary and manpage ...'
make obj && make && make install
ret=$?

restore ${bakdir}

if [[ ${ret} -ne 0 ]]; then
	echo "\nInstalling httpd-plus failed (exitcode: ${ret})."
	exit 1
fi
echo '\nInstalling httpd-plus binary and manpage completed successfully.'
echo "Please consult 'man httpd.conf' for further information on new features."
